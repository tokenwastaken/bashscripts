#!/bin/bash

echo Creating Partitions...
parted /dev/sda << END
mklabel gpt
unit mib
mkpart primary 1 3
name 1 grub
set 1 bios_grub on
mkpart primary 3 131
name 2 boot
set 2 boot on
mkpart primary 131 643
name 3 swap
mkpart primary 643 -1
name 4 rootfs
quit
;
END

echo creating filesystems...
mkfs.ext2 /dev/sda2
mkfs.ext4 /dev/sda4

echo mounting partitions...

mount /dev/sda4 /mnt/gentoo
mkswap /dev/sda3 swapon /dev/sda3
chmod 1777 /var/tmp

echo stage3..
cd /mnt/gentoo 
wget http://distfiles.gentoo.org/releases/amd64/autobuilds/20190814T214502Z/stage3-amd64-20190814T214502Z.tar.xz
cd /mnt/gentoo
tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner
cd /mnt/gentoo
echo MAKEOPTS="-j2" >> etc/portage/make.conf 
cd /mnt/gentoo
mirrorselect -i -o -c TURKEY -http >> /etc/portage/make.conf
cd /mnt/gentoo
cp --dereference /etc/resolv.conf /mnt/gentoo/etc/

mount --types proc /proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --make-rslave /mnt/gentoo/dev
 
chroot /mnt/gentoo /bin/bash
source /etc/profile
export PS1="(chroot) ${PS1}"

mount /dev/sda2 /boot
emerge-webrsync
